<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sentient Social Agent ‚Äî News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0e12; --panel:#11161c; --muted:#9aa4af; --text:#e8edf2;
      --edge:#1a2230; --accent:#16b1a9; --accent-2:#6ee7cf; --card:#0f141a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1280px;margin:0 auto;padding:20px 24px 24px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
    .logo{width:36px;height:36px;border-radius:9px;background:conic-gradient(from 220deg,var(--accent),#23b6ea 40%,#b48fff 70%,#ff8fb2);filter:saturate(1.3)}
    h1{font-size:22px;margin:0}
    .pill{font-size:11px;padding:4px 8px;border:1px solid var(--edge);border-radius:999px;color:#cfe8ff;background:#0a141c}

    /* layout */
    .layout{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width:1024px){ .layout{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg,var(--panel),#0e1319);
      border:1px solid var(--edge);
      border-radius:16px;
      box-shadow:0 8px 30px #0004;
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--edge);
      display:flex;align-items:center;justify-content:space-between
    }
    .card .hd h2{font-size:15px;margin:0;color:#dbe7f1;letter-spacing:.2px}
    .card .bd{padding:12px}

    .news-wrap{display:flex;flex-direction:column;gap:18px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:0 12px 10px}
    .tab{padding:6px 10px;border:1px solid var(--edge);border-radius:999px;color:#9aa4af;cursor:pointer;user-select:none}
    .tab.active{color:#0a1416;background:linear-gradient(180deg,var(--accent-2),var(--accent));border-color:transparent;font-weight:600}

    /* K√©o d√†i v√πng cu·ªôn b√™n tr√°i */
    .news-scroll{
      padding:12px;
      max-height: calc(100vh - 140px);
      overflow:auto;
    }
    @media (max-width:1024px){
      .news-scroll{ max-height:none; overflow:visible; }
    }

    .news-item{
      padding:12px;border:1px solid var(--edge);border-radius:12px;background:var(--card);
      margin:8px 0;display:grid;grid-template-columns:auto 170px;gap:12px
    }
    .news-item h3{margin:0 0 6px;font-size:15px;color:#dfe8f5}
    .news-meta{font-size:12px;color:#9aa4af}
    .btn{cursor:pointer;border:1px solid var(--edge);background:#0c151c;color:#dff; padding:8px 10px;border-radius:10px}
    .btn:hover{border-color:#2a3a4a}
    .btn.accent{border:none;background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#0b1114;font-weight:700}

    .col-summary .card{ position: sticky; top: 10px; }
    .summary-box{display:flex;gap:12px;align-items:flex-start}
    .mascot{width:44px;height:44px;border-radius:12px;background:#0c141c;border:1px solid var(--edge);display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto}
    .mascot img{width:100%;height:100%;object-fit:cover}
    .summary-content{white-space:pre-wrap;font-size:14px;color:#eaf7f5;flex:1;min-height:120px}
    .empty{color:#9aa4af;font-style:italic}

    .cta-row{margin-top:10px;display:flex;gap:8px}

    /* status line cho Deep Analysis */
    .status-line{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      font-style:italic;
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>Sentient Social Agent</h1>
      <span class="pill" id="status-pill">checking‚Ä¶</span>
    </header>

    <div class="layout">
      <!-- Left -->
      <div class="news-wrap">
        <div class="card news-card">
          <div class="hd">
            <h2>üì∞ News Feed</h2>
            <div class="tabs" id="tabs">
              <div class="tab active" data-cat="">All</div>
              <div class="tab" data-cat="tech">Tech</div>
              <div class="tab" data-cat="crypto">Crypto</div>
              <div class="tab" data-cat="finance">Finance</div>
              <div class="tab" data-cat="ai">AI</div>
            </div>
          </div>
          <div class="news-scroll" id="news-list"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="col-summary">
        <div class="card">
          <div class="hd"><h2>üß† Summary & Analysis</h2></div>
          <div class="bd">
            <div class="summary-box">
              <div class="mascot"><img src="assets/mascot.png" alt="mascot" /></div>
              <div style="flex:1">
                <div id="summary" class="summary-content empty">Pick a news item and click ‚ÄúSummarize‚Äù.</div>
                <div class="cta-row" id="deep-row" style="display:none">
                  <button id="btn-deep" class="btn">üîé Deep Analysis</button>
                </div>
                <div id="deep-status" class="status-line" style="display:none"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- layout -->
  </div> <!-- wrap -->

  <script>
    const $ = (q) => document.querySelector(q);
    const elNews = $("#news-list");
    const elSummary = $("#summary");
    const elDeepRow = $("#deep-row");
    const btnDeep = $("#btn-deep");
    const elDeepStatus = $("#deep-status");
    const statusPill = $("#status-pill");

    let currentArticle = null;
    let summarizeController = null;
    let sseSource = null;
    let spinnerTimer = null;

    function startSpinner(label){
      stopSpinner();
      let dots = 0;
      elDeepStatus.textContent = label + "‚Ä¶";
      elDeepStatus.style.display = "block";
      spinnerTimer = setInterval(()=>{
        dots = (dots+1)%4;
        elDeepStatus.textContent = label + ".".repeat(dots);
      }, 400);
    }
    function updateSpinner(label){
      if(elDeepStatus.style.display !== "block") elDeepStatus.style.display = "block";
      elDeepStatus.textContent = label + "‚Ä¶";
    }
    function stopSpinner(){
      if (spinnerTimer){ clearInterval(spinnerTimer); spinnerTimer = null; }
      elDeepStatus.style.display = "none";
      elDeepStatus.textContent = "";
    }

    async function status(){
      try{
        const r = await fetch("/api/status"); const j = await r.json();
        const ok = j?.status === "ok";
        statusPill.textContent = ok ? "online" : "error";
        statusPill.style.color = ok ? "#041818" : "#fff";
        statusPill.style.background = ok
          ? "linear-gradient(180deg,#8ef6e2,#16b1a9)"
          : "#5b1a1a";
      }catch{ statusPill.textContent = "offline"; }
    }
    status();

    // ------- News --------
    let currentCat = "";
    async function loadNews(){
      elNews.innerHTML = `<div class="empty">Loading news‚Ä¶</div>`;
      const url = currentCat ? `/api/news?category=${encodeURIComponent(currentCat)}&limit=50` : `/api/news?limit=50`;
      try{
        const r = await fetch(url); const j = await r.json();
        const items = j.articles || [];
        if(!items.length){ elNews.innerHTML = `<div class="empty">No news.</div>`; return; }
        elNews.innerHTML = items.map(a => `
          <div class="news-item">
            <div>
              <h3>${escapeHtml(a.title || '')}</h3>
              <div class="news-meta">${escapeHtml(a.source||'')} ¬∑ ${escapeHtml(a.category||'')} ¬∑ ${escapeHtml(a.published||'')}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <a class="btn" href="${a.link}" target="_blank" rel="noopener noreferrer">Open</a>
              <button class="btn accent" onclick='summ("${b64(JSON.stringify(a))}")'>Summarize</button>
            </div>
          </div>
        `).join("");
      }catch(e){
        elNews.innerHTML = `<div class="empty">Failed to load news.</div>`;
      }
    }
    function b64(s){return btoa(unescape(encodeURIComponent(s)))}
    function ub64(s){return decodeURIComponent(escape(atob(s)))}
    function escapeHtml(s){return (s||"").replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]))}
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.onclick = ()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        currentCat = tab.dataset.cat || "";
        loadNews();
      };
    });
    loadNews();

    // ------- Summarize (Fireworks only) --------
    async function summ(payloadB64){
      const a = JSON.parse(ub64(payloadB64));
      currentArticle = a;

      // ƒë√≥ng SSE c≈© + spinner c≈©
      try { sseSource?.close(); } catch {}
      stopSpinner();

      // h·ªßy deep-row tr·∫°ng th√°i & ·∫©n n√∫t deep (s·∫Ω hi·ªán l·∫°i sau khi t√≥m t·∫Øt xong)
      elDeepRow.style.display = "none";

      // abort summarize tr∆∞·ªõc ƒë√≥
      try { summarizeController?.abort(); } catch {}
      summarizeController = new AbortController();

      elSummary.classList.remove("empty");
      elSummary.textContent = "Summarizing‚Ä¶";

      try{
        const r = await fetch("/api/summarize", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ title:a.title, description:a.summary, url:a.link }),
          signal: summarizeController.signal
        });
        const j = await r.json();
        if(j.status==="success"){
          elSummary.innerHTML = mdToHtml(j.summary);
          // sau khi c√≥ summary: hi·ªán n√∫t Deep Analysis ƒë·ªÉ user b·∫•m
          elDeepRow.style.display = "flex";
        }else{
          elSummary.textContent = "Failed: " + (j.message||"");
        }
      }catch(e){
        if (e?.name === "AbortError") return;
        elSummary.textContent = "Connection error while summarizing.";
      }
    }

    // ------- Deep Analysis (SSE; ƒë√® k·∫øt qu·∫£ l√™n summary) --------
    btnDeep.onclick = ()=>{
      if (!currentArticle) return;

      // ·∫®n n√∫t ƒë·ªÉ tr√°nh b·∫•m l·∫°i trong l√∫c ch·∫°y
      elDeepRow.style.display = "none";

      // B·∫≠t status + spinner
      startSpinner("Preparing");

      // ƒë√≥ng SSE c≈© n·∫øu c√≥
      try { sseSource?.close(); } catch {}
      const params = new URLSearchParams({
        title: currentArticle.title || "",
        description: currentArticle.summary || "",
        url: currentArticle.link || ""
      });
      sseSource = new EventSource(`/api/deep_analyze_sse?${params.toString()}`);

      sseSource.onmessage = (e)=>{
        try{
          const msg = JSON.parse(e.data || "{}");
          if(msg.type === "stage"){
            // map stage -> label g·ªçn
            const stage = (msg.stage||"").toLowerCase();
            if (stage === "init")              updateSpinner("Preparing");
            else if (stage === "search_provider") updateSpinner("Searching");
            else if (stage === "reranker")       updateSpinner("Reranking");
            else if (stage === "llm_provider")   updateSpinner("Synthesizing analysis");
            else updateSpinner("Working");
          }else if(msg.type === "done"){
            stopSpinner();
            // ƒê√® k·∫øt qu·∫£ ph√¢n t√≠ch l√™n ph·∫ßn t√≥m t·∫Øt
            elSummary.innerHTML = mdToHtml(msg.analysis || "No analysis.");
            // n√∫t deep v·∫´n ·∫©n cho b√†i n√†y; khi t√≥m t·∫Øt b√†i kh√°c s·∫Ω hi·ªán l·∫°i
            try { sseSource?.close(); } catch {}
          }else if(msg.type === "error"){
            stopSpinner();
            elSummary.innerHTML += `<br/><span style="color:#f88">Deep Analysis failed: ${escapeHtml(msg.message||"")}</span>`;
            try { sseSource?.close(); } catch {}
            // Cho ph√©p b·∫•m l·∫°i n·∫øu mu·ªën
            elDeepRow.style.display = "flex";
          }
        }catch{}
      };
      sseSource.onerror = ()=>{
        stopSpinner();
        elSummary.innerHTML += `<br/><span style="color:#f88">Deep Analysis connection error.</span>`;
        try { sseSource?.close(); } catch {}
        // Cho ph√©p b·∫•m l·∫°i
        elDeepRow.style.display = "flex";
      };
    };

    function mdToHtml(md){
      let h = (md||"")
        .replace(/^(\s*)- (.*)$/gm,'$1‚Ä¢ $2')
        .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
        .replace(/_(.+?)_/g,'<i>$1</i>')
        .replace(/\[(.+?)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/\n/g,"<br/>");
      return h;
    }
  </script>
</body>
</html>
